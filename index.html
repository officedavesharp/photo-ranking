<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photography Selection Tool by Office D.SHARP</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='black'/></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f4;
            min-height: 100vh;
        }
        h1 {
            margin-top: 20px;
            margin-bottom: 40px;
        }
        .image-container {
            display: none;
            justify-content: center;
            align-items: center;
            margin: 20px;
            min-height: 750px;
        }
        .image-container img {
            width: auto;
            height: 750px;
            margin: 10px;
            cursor: pointer;
            border: 1px solid transparent;
            object-fit: contain;
        }
        .image-container img:hover {
            border-color: black;
        }
        .link {
            margin-top: 20px;
            text-decoration: none;
            color: #000;
            font-size: 16px;
            text-align: center;
        }
        .link:hover {
            text-decoration: underline;
        }
        .bottom-links {
            position: fixed;
            bottom: 40px;
            display: flex;
            gap: 40px;
            justify-content: center;
            width: 100%;
            left: 0;
        }
        .leaderboard-page {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 40px;
            padding: 40px;
            background-color: #f4f4f4;
            row-gap: 60px;
        }
        .leaderboard-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            height: 100%;
            opacity: 0;
            animation: fadeIn 0.3s ease-in forwards;
        }
        .leaderboard-item .image-wrapper {
            width: 100%;
            height: 300px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            background-color: #f4f4f4;
        }
        .leaderboard-item img {
            width: 100%;
            height: auto;
            object-fit: contain;
            max-height: 300px;
            display: block;
            flex-grow: 0;
            background-color: #f4f4f4;
        }
        .leaderboard-item span {
            position: relative;
            font-size: 14px;
            color: black;
            text-align: left;
            width: auto;
            background-color: #f4f4f4;
            padding: 0;
            margin-top: 8px;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }
        #progress-percentage {
            position: fixed;
            bottom: 40px;
            right: 40px;
            font-size: 16px;
            color: #000;
        }
        .logo {
            width: 300px;
            height: auto;
            margin: 40px 0 40px 0;
            cursor: pointer;
        }
        .pdf-layout {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px 20px;
            padding: 40px;
            background-color: white;
            width: 515px;
        }
        .pdf-layout .leaderboard-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background-color: white;
            opacity: 1;
        }
        .pdf-layout .image-container {
            width: 100%;
            position: relative;
            background-color: white;
        }
        .pdf-layout img {
            width: 100%;
            height: auto;
            object-fit: contain;
            background-color: white;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .overlay-content {
            background: white;
            padding: 20px 40px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .custom-file-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin: 20px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        .custom-file-input input[type="file"] {
            display: none;
        }
        .custom-file-button {
            padding: 10px 20px;
            background-color: black;
            color: white;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }
        .custom-file-button:hover {
            opacity: 0.9;
        }
        .custom-file-label {
            color: #555;
            font-size: 16px;
        }
        .description-text {
            color: #000;
            font-size: 16px;
            text-align: center;
            margin-bottom: 40px;
        }
        .description-text a {
            color: #000;
            text-decoration: underline;
        }
        .initial-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="initial-view">
        <img src="./static/Office D.SHARP.png" alt="Office D.SHARP" class="logo">
        <div class="custom-file-input">
            <label class="custom-file-button" for="folderInput">Select Images</label>
            <input type="file" id="folderInput" multiple accept="image/*" />
        </div>
        <div style="flex-grow: 1"></div>
        <div class="description-text">
            A tool by <a href="https://www.officedavesharp.com/" target="_blank" rel="noopener">Office D.SHARP</a> to assist with the selection of architectural photography
        </div>
    </div>
    <div class="image-container" id="image-container" style="display: none;">
        <img id="image1" src="" alt="Image 1" loading="lazy" style="display: none;">
        <img id="image2" src="" alt="Image 2" loading="lazy" style="display: none;">
    </div>
    <div id="progress-percentage">0%</div>
    <div class="bottom-links">
        <a href="#" class="link" id="view-leaderboard" style="display: none;">View Leaderboard</a>
    </div>

    <script>
        const images = [];
        const rankings = {};
        let currentPair = [];
        let nextPair = [];
        let nextPairElements = [];
        let comparisons = 0;
        let totalComparisons = 0; // Will be set dynamically
        let lastShownImages = new Set();
        const K_FACTOR = 32;
        let firstThresholdReached = false;
        let currentImageUrls = new Set(); // To track created URLs for cleanup
        let isLoading = false;

        // Add this new function to calculate optimal comparisons
        function calculateOptimalComparisons(imageCount) {
            let comparisonsPerImage;
            if (imageCount <= 30) {
                comparisonsPerImage = 8;
            } else if (imageCount <= 60) {
                comparisonsPerImage = 6;
            } else if (imageCount <= 100) {
                comparisonsPerImage = 5;
            } else {
                comparisonsPerImage = 4;
            }
            return Math.round((imageCount * comparisonsPerImage) / 2);
        }

        // Function to preload images
        function preloadImages(srcArray, callback) {
            let loadedCount = 0;
            const imgElements = [];

            srcArray.forEach((src, index) => {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    loadedCount++;
                    imgElements[index] = img;
                    if (loadedCount === srcArray.length) {
                        callback(imgElements);
                    }
                };
            });
        }

        // Function to calculate new ratings
        function calculateNewRatings(winner, loser) {
            const winnerRating = rankings[winner] || 1500;
            const loserRating = rankings[loser] || 1500;
            
            // Calculate expected scores
            const expectedWinner = 1 / (1 + Math.pow(10, (loserRating - winnerRating) / 400));
            const expectedLoser = 1 - expectedWinner;
            
            // Update ratings
            rankings[winner] = Math.round(winnerRating + K_FACTOR * (1 - expectedWinner));
            rankings[loser] = Math.round(loserRating + K_FACTOR * (0 - expectedLoser));
        }

        // Function to select next pair
        function selectNextPair() {
            const unratedImages = images.filter(img => !(img in rankings));
            const ratedImages = images.filter(img => img in rankings);
            
            // Remove recently shown images from consideration
            const availableUnrated = unratedImages.filter(img => !lastShownImages.has(img));
            const availableRated = ratedImages.filter(img => !lastShownImages.has(img));
            
            let selectedPair = [];
            
            // Priority 1: If we have unrated images, use at least one
            if (availableUnrated.length > 0) {
                selectedPair.push(availableUnrated[Math.floor(Math.random() * availableUnrated.length)]);
                
                // If we have another unrated image, prefer it
                const remainingUnrated = availableUnrated.filter(img => img !== selectedPair[0]);
                if (remainingUnrated.length > 0 && Math.random() < 0.7) { // 70% chance to pick another unrated
                    selectedPair.push(remainingUnrated[Math.floor(Math.random() * remainingUnrated.length)]);
                }
            }
            
            // If we still need another image, select from rated ones
            if (selectedPair.length < 2) {
                const firstRating = selectedPair.length > 0 ? (rankings[selectedPair[0]] || 1500) : 1500;
                
                // Sort available rated images by rating difference
                const sortedRated = availableRated
                    .filter(img => img !== selectedPair[0])
                    .sort((a, b) => {
                        const ratingA = rankings[a] || 1500;
                        const ratingB = rankings[b] || 1500;
                        return Math.abs(ratingA - firstRating) - Math.abs(ratingB - firstRating);
                    });
                
                // Select from the closest 3 ratings (if available) to ensure some randomness
                const poolSize = Math.min(3, sortedRated.length);
                selectedPair.push(sortedRated[Math.floor(Math.random() * poolSize)]);
            }
            
            // If we somehow still don't have 2 images, fill with random ones
            while (selectedPair.length < 2 && images.length >= 2) {
                const remainingImages = images.filter(img => 
                    !selectedPair.includes(img) && !lastShownImages.has(img)
                );
                if (remainingImages.length === 0) break;
                selectedPair.push(remainingImages[Math.floor(Math.random() * remainingImages.length)]);
            }
            
            // Update recently shown images
            lastShownImages.clear();
            selectedPair.forEach(img => lastShownImages.add(img));
            
            return selectedPair;
        }

        // Add this helper function at the top of your script section
        function loadImageWithRetry(src, maxRetries = 3, delay = 1000) {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                
                function attemptLoad() {
                    attempts++;
                    const img = new Image();
                    
                    img.onload = () => resolve(img);
                    
                    img.onerror = (error) => {
                        console.warn(`Attempt ${attempts} failed to load image:`, src);
                        if (attempts < maxRetries) {
                            setTimeout(attemptLoad, delay);
                        } else {
                            reject(new Error(`Failed to load image after ${maxRetries} attempts`));
                        }
                    };
                    
                    img.src = src;
                }
                
                attemptLoad();
            });
        }

        // Update the loadRandomPair function
        function loadRandomPair(callback) {
            if (isLoading) {
                console.warn('Already loading images, skipping this request');
                return;
            }
            
            const selectedPair = selectNextPair();
            
            if (!selectedPair || selectedPair.length !== 2) {
                console.error('Invalid pair selected:', selectedPair);
                return;
            }
            
            isLoading = true;
            
            Promise.all([
                loadImageWithRetry(selectedPair[0]),
                loadImageWithRetry(selectedPair[1])
            ])
            .then(([img1, img2]) => {
                nextPair = selectedPair;
                nextPairElements = [img1, img2];
                isLoading = false;
                if (callback) callback();
            })
            .catch(error => {
                console.error('Error in loadRandomPair:', error);
                isLoading = false;
                
                // Try one more time with a new pair
                const newPair = selectNextPair();
                if (newPair && newPair.length === 2) {
                    isLoading = true;
                    Promise.all([
                        loadImageWithRetry(newPair[0]),
                        loadImageWithRetry(newPair[1])
                    ])
                    .then(([img1, img2]) => {
                        nextPair = newPair;
                        nextPairElements = [img1, img2];
                        isLoading = false;
                        if (callback) callback();
                    })
                    .catch(error => {
                        console.error('Failed to load images after retry:', error);
                        isLoading = false;
                        alert('Error loading images. Please try again.');
                        resetSession();
                    });
                }
            });
        }

        // Update the displayNextPair function
        function displayNextPair() {
            if (isLoading) {
                console.warn('Already loading images, waiting...');
                setTimeout(() => displayNextPair(), 500);
                return;
            }
            
            if (nextPair.length === 0 || nextPairElements.length === 0) {
                console.error('No next pair available');
                return;
            }
            
            const img1 = document.getElementById('image1');
            const img2 = document.getElementById('image2');
            const container = document.getElementById('image-container');
            
            if (!img1 || !img2 || !container) {
                console.error('Required elements not found');
                return;
            }
            
            isLoading = true;
            
            // Hide current images while loading new ones
            img1.style.display = 'none';
            img2.style.display = 'none';
            
            // Ensure container is visible
            container.style.display = 'flex';
            
            Promise.all([
                loadImageWithRetry(nextPairElements[0].src),
                loadImageWithRetry(nextPairElements[1].src)
            ])
            .then(([loadedImg1, loadedImg2]) => {
                currentPair = nextPair;
                img1.src = loadedImg1.src;
                img2.src = loadedImg2.src;
                
                // Show images only after both are loaded
                requestAnimationFrame(() => {
                    img1.style.display = 'block';
                    img2.style.display = 'block';
                    isLoading = false;
                    
                    // Start loading next pair only after current pair is displayed
                    loadRandomPair();
                });
            })
            .catch(error => {
                console.error('Error in displayNextPair:', error);
                isLoading = false;
                alert('Error loading images. Please try again.');
                resetSession();
            });
        }

        // Extract file input handler into a named function
        function handleFileInput(event) {
            const files = event.target.files;
            const maxSize = 20 * 1024 * 1024; // 20MB in bytes
            
            // Clean up any existing object URLs
            currentImageUrls.forEach(url => {
                try {
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error revoking URL:', error);
                }
            });
            currentImageUrls.clear();
            images.length = 0;
            
            try {
                if (!files || files.length < 2) {
                    alert('Please select at least 2 images.');
                    return;
                }

                // Validate files first
                const validFiles = Array.from(files).filter(file => {
                    if (!file.type.startsWith('image/')) {
                        console.warn('Skipping non-image file:', file.name);
                        return false;
                    }
                    if (file.size > maxSize) {
                        console.warn('Skipping large file:', file.name);
                        return false;
                    }
                    return true;
                });

                if (validFiles.length < 2) {
                    alert('Please select at least 2 valid image files (each under 20MB).');
                    return;
                }

                // Create object URLs for valid files
                validFiles.forEach(file => {
                    try {
                        const url = URL.createObjectURL(file);
                        currentImageUrls.add(url);
                        images.push(url);
                    } catch (error) {
                        console.error('Error creating object URL for file:', file.name, error);
                    }
                });

                if (images.length < 2) {
                    throw new Error('Failed to process enough valid images');
                }

                // Set the total comparisons based on image count
                totalComparisons = calculateOptimalComparisons(images.length);
                
                // Remove initial view and show ranking interface
                document.querySelector('.initial-view').style.display = 'none';
                
                // Add logo back
                const logo = document.createElement('img');
                logo.src = './static/Office D.SHARP.png';
                logo.alt = 'Office D.SHARP';
                logo.className = 'logo';
                logo.onclick = resetSession;
                document.body.insertBefore(logo, document.body.firstChild);
                
                // Show container and leaderboard link
                const container = document.getElementById('image-container');
                container.style.display = 'flex';
                document.getElementById('view-leaderboard').style.display = 'block';
                
                // Preload first pair of images before displaying
                const firstPair = selectNextPair();
                currentPair = firstPair;
                
                // Create and preload both images
                const preloadFirstPair = async () => {
                    try {
                        const loadedImages = await Promise.all([
                            loadImageWithRetry(firstPair[0]),
                            loadImageWithRetry(firstPair[1])
                        ]);
                        
                        const img1 = document.getElementById('image1');
                        const img2 = document.getElementById('image2');
                        
                        img1.src = loadedImages[0].src;
                        img2.src = loadedImages[1].src;
                        
                        img1.style.display = 'block';
                        img2.style.display = 'block';
                        
                        // Start loading next pair
                        loadRandomPair();
                        
                        // Attach event listeners
                        attachEventListeners();
                    } catch (error) {
                        console.error('Error loading initial images:', error);
                        alert('Error loading images. Please try again.');
                        resetSession();
                    }
                };

                preloadFirstPair();
            } catch (error) {
                console.error('Error in handleFileInput:', error);
                alert('An error occurred while processing the images. Please try again.');
                resetSession();
            }
        }

        // Attach file input handler
        document.getElementById('folderInput').addEventListener('change', handleFileInput);

        // Function to update progress percentage
        function updateProgress() {
            const progress = Math.min((comparisons / totalComparisons) * 100, 100);
            document.getElementById('progress-percentage').innerText = `${Math.floor(progress)}%`;
        }

        // Function to handle image click
        function handleImageClick(selectedImage) {
            if (isLoading) {
                console.warn('Images are still loading, ignoring click');
                return;
            }
            
            const otherImage = currentPair.find(img => img !== selectedImage);
            calculateNewRatings(selectedImage, otherImage);
            comparisons++;
            updateProgress();
            
            if (comparisons >= totalComparisons && !firstThresholdReached) {
                firstThresholdReached = true;
                showLeaderboard();
            } else {
                if (nextPair.length === 0 || nextPairElements.length === 0) {
                    loadRandomPair(() => displayNextPair());
                } else {
                    displayNextPair();
                }
            }
        }

        // Event listeners
        function attachEventListeners() {
            const img1 = document.getElementById('image1');
            const img2 = document.getElementById('image2');
            
            if (!img1 || !img2) {
                console.error('Image elements not found!'); // Debug log
                return;
            }
            
            img1.addEventListener('click', () => {
                console.log('Image 1 clicked'); // Debug log
                handleImageClick(currentPair[0]);
            });
            img2.addEventListener('click', () => {
                console.log('Image 2 clicked'); // Debug log
                handleImageClick(currentPair[1]);
            });
        }

        attachEventListeners();

        // Function to preload leaderboard images
        function preloadLeaderboardImages(imageUrls, batchSize = 14) { // 2 rows worth of images
            return new Promise((resolve) => {
                const batches = [];
                for (let i = 0; i < imageUrls.length; i += batchSize) {
                    batches.push(imageUrls.slice(i, i + batchSize));
                }
                resolve(batches);
            });
        }

        // Update the leaderboard click handler
        document.getElementById('view-leaderboard').addEventListener('click', (e) => {
            e.preventDefault();
            showLeaderboard();
        });

        // Add this new function to create thumbnails
        function createThumbnail(imageUrl, maxWidth = 300, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate dimensions while preserving aspect ratio
                    const ratio = img.width / img.height;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        width = maxWidth;
                        height = width / ratio;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(imageUrl);
                img.src = imageUrl;
            });
        }

        // Update the showLeaderboard function
        async function showLeaderboard() {
            // Show loading overlay
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.innerHTML = `
                <div class="overlay-content">
                    Loading Leaderboard
                </div>
            `;
            document.body.appendChild(overlay);

            try {
                const body = document.body;
                body.innerHTML = `
                    <img src="./static/Office D.SHARP.png" alt="Office D.SHARP" class="logo" onclick="restoreRankingPage()">
                    <div class="leaderboard-page"></div>
                `;
                
                // Re-add the overlay since we just overwrote the body
                document.body.appendChild(overlay);
                
                const container = document.querySelector('.leaderboard-page');
                const sortedImages = Object.keys(rankings).sort((a, b) => rankings[b] - rankings[a]);
                
                // First, create all thumbnails
                const thumbnailPromises = sortedImages.map(image => 
                    createThumbnail(image, 300, 0.85)
                );
                
                // Wait for all thumbnails to be created
                const thumbnails = await Promise.all(thumbnailPromises);
                
                // Create and load all items with their thumbnails
                const loadPromises = thumbnails.map((thumbnail, index) => {
                    return new Promise(resolve => {
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.style.opacity = '0'; // Start hidden
                        
                        const imageWrapper = document.createElement('div');
                        imageWrapper.className = 'image-wrapper';
                        
                        const img = new Image();
                        const span = document.createElement('span');
                        span.textContent = (index + 1).toString();
                        
                        img.onload = resolve;
                        img.src = thumbnail;
                        
                        imageWrapper.appendChild(img);
                        item.appendChild(imageWrapper);
                        item.appendChild(span);
                        container.appendChild(item);
                    });
                });
                
                // Wait for all images to load
                await Promise.all(loadPromises);
                
                // Show all items with fade in
                document.querySelectorAll('.leaderboard-item').forEach(item => {
                    item.style.opacity = '1';
                    item.style.transition = 'opacity 0.3s ease-in';
                });
                
                // Add bottom links after images are loaded
                const bottomLinks = document.createElement('div');
                bottomLinks.className = 'bottom-links';
                bottomLinks.innerHTML = `
                    <a href="#" class="link" id="back-link">Continue Ranking</a>
                    <a href="#" class="link" id="download-pdf">Download PDF</a>
                `;
                document.body.appendChild(bottomLinks);
                
                // Add event listeners
                document.getElementById('back-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    restoreRankingPage();
                });
                
                document.getElementById('download-pdf').addEventListener('click', (e) => {
                    e.preventDefault();
                    generatePDF();
                });
                
                // Remove loading overlay only after everything is ready
                document.body.removeChild(overlay);
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.body.removeChild(overlay);
            }
        }

        // Update restoreRankingPage function
        function restoreRankingPage() {
            document.body.innerHTML = `
                <img src="./static/Office D.SHARP.png" alt="Office D.SHARP" class="logo" onclick="resetSession()">
                <div class="image-container" id="image-container">
                    <img id="image1" src="" alt="Image 1" loading="lazy" style="display: none;">
                    <img id="image2" src="" alt="Image 2" loading="lazy" style="display: none;">
                </div>
                <div id="progress-percentage">${Math.floor((comparisons / totalComparisons) * 100)}%</div>
                <div class="bottom-links">
                    <a href="#" class="link" id="view-leaderboard">View Leaderboard</a>
                </div>
            `;
            
            // Reattach event listeners
            attachEventListeners();
            document.getElementById('view-leaderboard').addEventListener('click', (e) => {
                e.preventDefault();
                showLeaderboard();
            });

            // Show container but keep images hidden until loaded
            document.getElementById('image-container').style.display = 'flex';
            document.getElementById('view-leaderboard').style.display = 'block';
            
            if (currentPair.length === 2) {
                // Use displayNextPair to handle image loading properly
                nextPair = currentPair;
                nextPairElements = currentPair.map(src => {
                    const img = new Image();
                    img.src = src;
                    return img;
                });
                displayNextPair();
            } else {
                // If somehow currentPair is empty, start fresh
                loadRandomPair(() => {
                    displayNextPair();
                });
            }
        }

        // Update the generatePDF function to fix PDF generation
        async function generatePDF() {
            // Show overlay
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.innerHTML = `
                <div class="overlay-content">
                    Generating PDF
                </div>
            `;
            document.body.appendChild(overlay);

            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    console.error('jsPDF not loaded');
                    return;
                }

                const pdfDiv = document.createElement('div');
                pdfDiv.className = 'pdf-layout';
                pdfDiv.style.position = 'absolute';
                pdfDiv.style.left = '-9999px';
                pdfDiv.style.backgroundColor = 'white';
                document.body.appendChild(pdfDiv);
                
                const sortedImages = Object.keys(rankings).sort((a, b) => rankings[b] - rankings[a]);
                const doc = new jsPDF('p', 'pt', 'a4');
                
                // A4 dimensions and margins
                const pageWidth = 595;
                const pageHeight = 842;
                const margin = 40;
                const bottomMargin = 60; // Increased bottom margin
                const contentWidth = pageWidth - (2 * margin);
                
                // Logo setup
                const logo = document.querySelector('.logo');
                const logoRatio = logo.naturalWidth / logo.naturalHeight;
                const logoWidth = 200;
                const logoHeight = logoWidth / logoRatio;
                const logoX = (pageWidth - logoWidth) / 2;
                const topMargin = 45; // Increased top margin for logo
                
                // Items per page calculation (3 rows of 3 for first page, 3 rows for others)
                const itemsPerFirstPage = 9;
                const itemsPerOtherPage = 9;
                const pages = Math.ceil((sortedImages.length - itemsPerFirstPage) / itemsPerOtherPage) + 1;
                
                for (let page = 0; page < pages; page++) {
                    if (page > 0) doc.addPage();
                    
                    // Only add logo on first page
                    if (page === 0) {
                        doc.addImage(logo.src, 'PNG', logoX, topMargin, logoWidth, logoHeight);
                    }
                    
                    pdfDiv.innerHTML = '';
                    const startIndex = page === 0 ? 0 : itemsPerFirstPage + (page - 1) * itemsPerOtherPage;
                    const itemsThisPage = page === 0 ? itemsPerFirstPage : itemsPerOtherPage;
                    const pageImages = sortedImages.slice(startIndex, startIndex + itemsThisPage);
                    
                    // Create all thumbnails for this page with higher quality
                    const thumbnails = await Promise.all(
                        pageImages.map(img => createThumbnail(img, 800, 1.0))
                    );
                    
                    thumbnails.forEach((thumbnail, i) => {
                        const itemNumber = startIndex + i + 1;
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.style.backgroundColor = 'white';
                        item.innerHTML = `
                            <div style="width: 100%; background-color: white; display: flex; flex-direction: column; align-items: flex-start;">
                                <div style="width: 100%; height: 225px; display: flex; align-items: flex-start; justify-content: center; background-color: white;">
                                    <img src="${thumbnail}" alt="Image" 
                                        style="max-width: 100%; max-height: 225px; width: auto; height: auto; object-fit: contain; background-color: white; display: block;">
                                </div>
                                <div style="width: 100%; padding: 0; margin-top: -3px; background-color: white;">
                                    <span style="font-size: 12px; line-height: 14px; font-family: Arial, sans-serif; color: black; background-color: white; display: block;">
                                        ${itemNumber}
                                    </span>
                                </div>
                            </div>
                        `;
                        pdfDiv.appendChild(item);
                    });
                    
                    const yOffset = page === 0 ? logoHeight + topMargin : margin;
                    
                    const canvas = await html2canvas(pdfDiv, {
                        backgroundColor: 'white',
                        scale: 4,
                        logging: false,
                        useCORS: true,
                        imageTimeout: 0,
                        removeContainer: true,
                        allowTaint: false,
                        foreignObjectRendering: false,
                        onclone: function(clonedDoc) {
                            const images = clonedDoc.getElementsByTagName('img');
                            for(let img of images) {
                                // Reset any transforms or positioning
                                img.style.transform = 'none';
                                img.style.position = 'static';
                                img.style.display = 'block';
                                
                                // Let the image size itself naturally within its container
                                img.style.maxWidth = '100%';
                                img.style.maxHeight = '300px';
                                img.style.width = 'auto';
                                img.style.height = 'auto';
                                img.style.objectFit = 'contain';
                            }
                        }
                    });
                    
                    // Add the image at full content width
                    doc.addImage(
                        canvas.toDataURL('image/jpeg', 1.0),
                        'JPEG',
                        margin,
                        yOffset,
                        contentWidth,
                        (contentWidth * canvas.height) / canvas.width,
                        '',
                        'FAST',
                        0
                    );
                }
                
                doc.save('leaderboard.pdf');
                document.body.removeChild(pdfDiv);
            } catch (error) {
                console.error('PDF generation error:', error);
            } finally {
                document.body.removeChild(overlay);
            }
        }

        // Add resetSession function
        function resetSession() {
            isLoading = false;
            // Clean up object URLs
            currentImageUrls.forEach(url => URL.revokeObjectURL(url));
            currentImageUrls.clear();
            
            // Clear all data
            images.length = 0;
            Object.keys(rankings).forEach(key => delete rankings[key]);
            currentPair = [];
            nextPair = [];
            nextPairElements = [];
            comparisons = 0;
            totalComparisons = 0;
            lastShownImages.clear();
            firstThresholdReached = false;
            
            // Reset UI to initial state
            document.body.innerHTML = `
                <div class="initial-view">
                    <img src="./static/Office D.SHARP.png" alt="Office D.SHARP" class="logo">
                    <div class="custom-file-input">
                        <label class="custom-file-button" for="folderInput">Select Images</label>
                        <input type="file" id="folderInput" multiple accept="image/*" />
                    </div>
                    <div style="flex-grow: 1"></div>
                    <div class="description-text">
                        A tool by <a href="https://www.officedavesharp.com/" target="_blank" rel="noopener">Office D.SHARP</a> to assist with the selection of architectural photography
                    </div>
                </div>
                <div class="image-container" id="image-container" style="display: none;">
                    <img id="image1" src="" alt="Image 1" loading="lazy" style="display: none;">
                    <img id="image2" src="" alt="Image 2" loading="lazy" style="display: none;">
                </div>
                <div id="progress-percentage">0%</div>
                <div class="bottom-links">
                    <a href="#" class="link" id="view-leaderboard" style="display: none;">View Leaderboard</a>
                </div>
            `;
            
            // Reattach event listener for file input
            document.getElementById('folderInput').addEventListener('change', handleFileInput);
        }
    </script>
</body>
</html>
